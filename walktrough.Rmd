---
title: "Wheat Strip Rust Example"
author: "Chris Jones"
date: "7/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(folderfun)
library(sp)
folderfun::setff("In","C:/Users/Chris/Desktop/Projects/pops_casestudies/wheat-stripe-rust/data/") # This needs to be changed to your local directory

```

## Background

Here we are simulating a field experiment with a 5 * 28 plot with 1.52 m x 1.52 m (5 ft by 5ft) grid 
cells for wheat strip rust. The experiment was planted with a non-resistnat variety of wheat and
multiple treatments were performed. Here we are going to walk through setting up the data for the
model and the treatments. We are ignoring the effect of weather on disease spread as we are in a 
small spatial extent and don't have climate data at a scale that would make locations meaninfully
different from each other.

## Data setup
# Initial conditions

The experimental design was such that each field was plant exactly in the same manner and then
1.33% of the total population of 

```{r data_prep}
res <- 1.52
ns_ext <- 5
we_ext <- 28
control <- raster::raster(matrix(0, nrow = ns_ext, ncol =we_ext), xmn = 0, xmx = we_ext*res, ymn = 0, ymx = ns_ext*res)
initial_infection <- raster::raster(matrix(0, nrow = ns_ext, ncol =we_ext), xmn = 0, xmx = we_ext*res, ymn = 0, ymx = ns_ext*res)
initial_infection[3,4] <- 13
ii_points <-  rasterToPoints(initial_infection, spatial = TRUE)
ii_points <- ii_points[ii_points$layer > 0,]
hosts <- raster::raster(matrix(1000, nrow = ns_ext, ncol =we_ext), xmn = 0, xmx = we_ext*res, ymn = 0, ymx = ns_ext*res)
total_hosts <- raster::raster(matrix(1000, nrow = ns_ext, ncol =we_ext), xmn = 0, xmx = we_ext*res, ymn = 0, ymx = ns_ext*res)
treatment_foci <- raster::raster(matrix(0, nrow = ns_ext, ncol =we_ext), xmn = 0, xmx = we_ext*res, ymn = 0, ymx = ns_ext*res)
treatment_foci[3,4] <- 1
treatment_3x3 <- treatment_foci
treatment_3x3[2:4, 3:5] <- 1
treatment_5x5 <- treatment_foci
treatment_5x5[1:5, 2:6] <- 1
sample_locations <- treatment_foci
sample_locations[3, c(4,6,8,10,12,14, 16, 18, 20, 22, 24)] <- 1
sl_points <-  rasterToPoints(sample_locations, spatial = TRUE)
sl_points <- sl_points[sl_points$layer > 0,]
writeRaster(initial_infection, ffIn("infected.tif"), overwrite = TRUE)
writeRaster(total_hosts, ffIn("total_hosts.tif"), overwrite = TRUE)
writeRaster(hosts, ffIn("hosts.tif"), overwrite = TRUE)
writeRaster(treatment_foci, ffIn("treatments_foci.tif"), overwrite = TRUE)
writeRaster(treatment_3x3, ffIn("treatments_3x3.tif"), overwrite = TRUE)
writeRaster(treatment_5x5, ffIn("treatments_5x5.tif"), overwrite = TRUE)
writeRaster(sample_locations, ffIn("sample_locations.tif"), overwrite = TRUE)
## Still need to create e

```

## Plotting the experimental Setup

s

```{r experiment, echo=FALSE}
plot(control, main = "Control Plots", sub = "With initial inoculation and sample locations", col = "gray95")
plot(ii_points, pch = 20, col = "red", add = TRUE)
plot(sl_points, add = TRUE)


plot(treatment_foci, main = "Treatment Plots 1 Foci width", sub = "With initial inoculation and sample locations")
plot(ii_points, add = TRUE, pch = 20, col = "red")
plot(sl_points, add = TRUE)

plot(treatment_3x3, main = "Treatment Plots 3 Foci width", sub = "With initial inoculation and sample locations")
plot(ii_points, add = TRUE, pch = 20, col = "red")
plot(sl_points, add = TRUE)

plot(treatment_5x5, main = "Treatment Plots 3 Foci width", sub = "With initial inoculation and sample locations")
plot(ii_points, add = TRUE, pch = 20, col = "red")
plot(sl_points, add = TRUE)

```


## Setting up the calibration

```{r}

# infected_years_file <- ffIn("purelines_7weeks.tif")
# number_of_observations <- 100  ### This is the number of infected cells or total observations - just make sure it's consistent across each temporal step of your data
# prior_number_of_observations <- 0
# prior_means <- c(0, 0, 0, 0, 0, 0)    ### leave as 0 for now, means that you are giving them no weight
# prior_cov_matrix <- matrix(ncol = 6, nrow = 6, 0)
# params_to_estimate <- c(T, T, F, F, T, F)  ### 1st: reproductive rates, 2nd: natural distance, 3rd: percent natural, 4tH: anthropogenic distance, 5th Natural Kappa, 6th anthropogenic kappa
# number_of_generations <- 7 # this is how many generations the approximate bayesian computation algorithm runs
# generation_size <- 50 # the number of accepted runs of the model below the threshold.
# checks = c(90, 20000, 164000, 8000)   # 1: difference between number of infected cells in different years, 2: difference in distance in different years
# # 3 and 4 don't matter if you keep the metric of success the same
# infected_file <- ffIn("infected.tif")
# host_file <- ffIn("hosts.tif")
# total_plants_file <- ffIn("total_hosts.tif")
# temp <- FALSE
# temperature_coefficient_file <- ""
# precip <- FALSE
# precipitation_coefficient_file <- ""
# model_type = "SEI"
# latency_period = 16
# time_step <- "day"
# season_month_start <- 1
# season_month_end <- 12
# start_date <- '2003-01-01'
# end_date <- '2003-02-18'
# use_lethal_temperature <- FALSE
# temperature_file <- ""
# lethal_temperature <- -30
# lethal_temperature_month <- 1
# mortality_on <- FALSE
# mortality_rate <- 0
# mortality_time_lag <- 0
# management <- FALSE
# treatment_dates <- c('2003-01-24')
# treatments_file <- ""
# treatment_method <- "ratio"
# natural_kernel_type <- "cauchy"
# anthropogenic_kernel_type <- "cauchy"
# natural_dir <- "E"
# natural_kappa <- 0
# anthropogenic_dir <- "NONE"
# anthropogenic_kappa <- 0
# pesticide_duration <- c(0)
# pesticide_efficacy <- 1.0
# mask <- NULL
# success_metric <- "residual error"  # residual error makes a direct comparison to the field measurements that are of disease severity or infected area
# output_frequency <- "week"
# movements_file = ""  ## ignore - for when hosts move (animals moving from farm to farm)
# use_movements = FALSE
# percent_natural_dispersal <- 1.0
# anthropogenic_distance_scale <- 0.0
# 
# calibrated_data <- abc_calibration(infected_years_file,
#                                number_of_observations,
#                                prior_number_of_observations,
#                                prior_means, prior_cov_matrix,
#                                params_to_estimate,
#                                number_of_generations,
#                                generation_size,
#                                checks,
#                                infected_file,
#                                host_file,
#                                total_plants_file,
#                                temp,
#                                temperature_coefficient_file,
#                                precip,
#                                precipitation_coefficient_file,
#                                model_type,
#                                latency_period,
#                                time_step,
#                                season_month_start,
#                                season_month_end,
#                                start_date,
#                                end_date,
#                                use_lethal_temperature,
#                                temperature_file,
#                                lethal_temperature,
#                                lethal_temperature_month,
#                                mortality_on,
#                                mortality_rate,
#                                mortality_time_lag,
#                                management,
#                                treatment_dates,
#                                treatments_file,
#                                treatment_method,
#                                natural_kernel_type,
#                                anthropogenic_kernel_type,
#                                natural_dir,
#                                natural_kappa,
#                                anthropogenic_dir,
#                                anthropogenic_kappa,
#                                pesticide_duration,
#                                pesticide_efficacy,
#                                mask,
#                                success_metric,
#                                output_frequency,
#                                movements_file,
#                                use_movements)
# 
# means_purelines = as.data.frame(hyslop_farm$posterior_means)
# cov_purelines = as.data.frame(hyslop_farm$posterior_cov_matrix)
# raw_calib_purelines = as.data.frame(hyslop_farm$raw_calibration_data)
# total_obs_purelines = as.data.frame(hyslop_farm$total_number_of_observations)
# write.csv(total_obs_purelines, ffOut("total_obs.csv"))
# write.csv(means_purelines, ffOut("means_purelines.csv"), row.names = FALSE)
# write.csv(cov_purelines, ffOut("cov_purelines.csv"), row.names = FALSE)
# write.csv(raw_calib_purelines, ffOut("raw_calib_purelines.csv"))
```




## Plotting Calibration curves



```{r pressure, echo=FALSE}

```

## Run model

```{r}

infected_years_file <- ffIn("purelines_7weeks.tif")
parameter_means <- read.csv(ffIncal("means_purelines.csv"))[[1]]
parameter_cov_matrix <- read.csv(ffIncal("cov_purelines.csv"))
# infected_file <- ffIn("infected.tif")
# host_file <- ffIn("hosts.tif")
# total_plants_file <- ffIn("total_hosts.tif")
temp <- FALSE
temperature_coefficient_file <- ""
precip <- FALSE
precipitation_coefficient_file <- ""
model_type = "SEI"
latency_period = 14
time_step <- "day"
season_month_start <- 1
season_month_end <- 12
start_date <- '2003-01-01'
end_date <- '2003-02-18'
use_lethal_temperature <- FALSE
temperature_file <- ""
lethal_temperature <- -30
lethal_temperature_month <- 1
mortality_on <- FALSE
mortality_rate <- 0
mortality_time_lag <- 0
management <- FALSE
treatment_dates <- c('2003-01-24')
treatments_file <- ""
treatment_method <- "ratio"
natural_kernel_type <- "cauchy"
anthropogenic_kernel_type <- "cauchy"
natural_dir <- "E"
anthropogenic_dir <- "NONE"
pesticide_duration <- c(0)
pesticide_efficacy <- 1.0
mask <- NULL
success_metric <- "residual error"  ### keep this the same
output_frequency <- "week"
movements_file = ""  ## ignore - for pigs
use_movements = FALSE
number_of_iterations <- 10
number_of_cores <- 2
s <- pops_multirun(infected_file, 
                   host_file, 
                   total_plants_file,
                   parameter_means,
                   parameter_cov_matrix,
                   temp, 
                   temperature_coefficient_file, 
                   precip, 
                   precipitation_coefficient_file,
                   model_type, 
                   latency_period,
                   time_step, 
                   season_month_start, 
                   season_month_end, 
                   start_date, 
                   end_date, 
                   use_lethal_temperature,
                   temperature_file,
                   lethal_temperature, 
                   lethal_temperature_month,
                   mortality_on, 
                   mortality_rate, 
                   mortality_time_lag, 
                   management, 
                   treatment_dates, 
                   treatments_file,
                   treatment_method,
                   natural_kernel_type, 
                   anthropogenic_kernel_type,
                   natural_dir, 
                   anthropogenic_dir, 
                   number_of_iterations, 
                   number_of_cores,
                   pesticide_duration,
                   pesticide_efficacy,
                   random_seed = NULL,
                   output_frequency,
                   movements_file, 
                   use_movements)
```

